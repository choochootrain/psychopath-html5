<html>
  <head>
    <title>Psychopath HTML5</title>

    <script type="text/javascript" src="./enchant.js"></script>
    <script>
      var generateCollisionData = function(mapData) {
        var collisionData = [];
        for (var i = 0; i < mapData.length; i++) {
          var row = mapData[i];
          collisionData.push([]);
          for (var j = 0; j < row.length; j++) {
            collisionData[i].push(row[j] == 1 ? 1 : 0);
          }
        }
        return collisionData;
      }

      var new2dArray = function(rows, cols) {
        var arr = new Array(rows);
        for (var i = 0; i < arr.length; i++) {
          arr[i] = new Array(cols)
        }
        return arr;
      };

      var extractMapBlocks = function(map) {
        for (var i = 0; i < map.length; i++) {
          var row = map[i];
          for (var j = 0; j < row.length; j++) {
            if (row[j] == 2) {
              blocks[i][j] = newBlock(i, j);
              row[j] = 0;
            }
          }
        }
        return map;
      };

      var newBlock = function(x, y) {
        var block = new Sprite(32, 32);
        block.image = game.assets['block.png'];
        block.x = x * 32;
        block.y = y * 32;
        return block;
      }

      var addBlocks = function(blocks) {
        for (var i = 0; i < blocks.length; i++) {
          var row = blocks[i];
          for (var j = 0; j < row.length; j++) {
            if (row[j]) {
              scene.addChild(row[j]);
            }
          }
        }
      };

      enchant();
      window.onload = function() {
        game = new Game(600, 600);
        game.preload('tiles.png', 'player.png', 'block.png');

        player = new Sprite(32, 32);
        scene = new Scene();
        map = new Map(32,32);
        blocks = new2dArray(16, 16);
        game.onload = function() {
          game.pushScene(scene);

          baseMap = extractMapBlocks([
            [  0,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1],
            [  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1],
            [  0,  2,  0,  0,  1,  0,  0,  0,  0,  1,  0,  1,  0,  2,  1,  1],
            [  0,  0,  0,  0,  0,  1,  0,  2,  0,  0,  1,  0,  0,  0,  0,  1],
            [  0,  2,  0,  2,  0,  0,  0,  0,  0,  1,  0,  1,  1,  0,  2,  0],
            [  0,  2,  0,  0,  0,  0,  0,  1,  0,  0,  0,  2,  0,  0,  0,  0],
            [  0,  0,  2,  0,  2,  0,  0,  0,  2,  1,  2,  0,  0,  1,  0,  0],
            [  0,  2,  0,  2,  0,  0,  2,  0,  2,  0,  2,  0,  0,  0,  1,  0],
            [  0,  0,  0,  0,  0,  0,  0,  2,  0,  2,  0,  0,  1,  0,  0,  0],
            [  0,  0,  0,  2,  0,  2,  0,  0,  1,  0,  2,  1,  0,  0,  2,  0],
            [  0,  0,  0,  2,  0,  0,  1,  0,  0,  0,  2,  0,  0,  1,  0,  0],
            [  1,  2,  0,  0,  0,  2,  0,  2,  0,  0,  0,  0,  2,  0,  0,  0],
            [  1,  2,  0,  0,  2,  0,  0,  0,  1,  1,  0,  1,  0,  0,  0,  1],
            [  1,  2,  0,  2,  0,  2,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1],
            [  1,  0,  2,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1],
            [  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1],
          ]);


          map.image = game.assets['tiles.png'];
          map.loadData(baseMap);
          map.collisionData = generateCollisionData(baseMap);
          scene.addChild(map);

          addBlocks(blocks);

          player.image = game.assets['player.png'];
          player.x = 64;
          player.y = 64;
          scene.addChild(player);
        };

        game.addEventListener('leftbuttondown', function() {
          move(player, -1, 0);
        });

        game.addEventListener('rightbuttondown', function() {
          move(player, 1, 0);
        });

         game.addEventListener('upbuttondown', function() {
          move(player, 0, -1);
        });

         game.addEventListener('downbuttondown', function() {
          move(player, 0, 1);
        });

        var inBounds = function(x, y) {
          return x >= 0 && x <= 15*32 && y >= 0 && y <= 15*32;
        }

        var move = function(sprite, xinc, yinc) {
          var nx = sprite.x + 32*xinc;
          var ny = sprite.y + 32*yinc;

          if (!map.hitTest(nx, ny) && inBounds(nx, ny)) {
            sprite.x = nx;
            sprite.y = ny;
          }
        };

        game.start();
      }
    </script>
  </head>

  <body>
  </body>
</html>
